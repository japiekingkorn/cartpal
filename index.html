<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CartPal">
    <title>CartPal</title>

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        #root {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav {
            padding-bottom: 4rem;
        }
        @supports (padding: max(0px)) {
            .bottom-nav {
                padding-bottom: max(4rem, env(safe-area-inset-bottom));
            }
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #325220;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease-in-out 1.5s forwards;
            margin: 0;
            padding: 0;
        }

        #splash-logo {
            width: 280px;
            height: 280px;
            object-fit: contain;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to   { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to   { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <img id="splash-logo" src="icons/icon-192.png" alt="CartPal Logo">
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* ---------------------- ICONS ----------------------- */
        const CartIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 9h14l-2-9M10 21a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z" />
            </svg>
        );

        const StoreIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M3 9l1-5h16l1 5M4 9h16v11H4V9z" />
            </svg>
        );

        const ItemsIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M4 6h16M4 12h16M4 18h7" />
            </svg>
        );

        const FolderIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M3 7h5l2 2h11v10H3z" />
            </svg>
        );

        const InfoIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const PlusIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M12 4v16m8-8H4" />
            </svg>
        );

        const MinusIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M20 12H4" />
            </svg>
        );

        const ChevronRightIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M9 5l7 7-7 7" />
            </svg>
        );

        const ChevronDownIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M19 9l-7 7-7-7" />
            </svg>
        );

        const ChevronRightSmallIcon = ChevronRightIcon;

        const XIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const UploadIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const CheckIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                      d="M5 13l4 4L19 7" />
            </svg>
        );

        /* --------------- MODALS --------------- */

        function ItemDetailModal({ item, stores, categories, onSave, onClose, onDelete }) {
            const [editingItem, setEditingItem] = useState({
                name: item.name,
                categoryId: item.categoryId,
                storeData: { ...(item.storeData || {}) }
            });

            const handleSave = () => {
                const updates = {
                    ...editingItem,
                    categoryId: editingItem.categoryId
                };
                onSave(item.id, updates);
                onClose();
            };

            const handleDelete = () => {
                if (confirm(`Delete "${item.name}"?`)) {
                    onDelete(item.id);
                    onClose();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-md max-h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-lg font-bold">Item Details</h2>
                            <button onClick={onClose}><XIcon /></button>
                        </div>
                        <div className="p-4 space-y-4 overflow-auto">
                            <div>
                                <label className="block text-sm font-semibold mb-1">Name</label>
                                <input
                                    type="text"
                                    value={editingItem.name}
                                    onChange={(e) =>
                                        setEditingItem(prev => ({ ...prev, name: e.target.value }))
                                    }
                                    className="w-full px-3 py-2 border rounded"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-1">Category</label>
                                <select
                                    value={editingItem.categoryId}
                                    onChange={(e) =>
                                        setEditingItem(prev => ({ ...prev, categoryId: Number(e.target.value) }))
                                    }
                                    className="w-full px-3 py-2 border rounded"
                                >
                                    {categories.map(cat => (
                                        <option key={cat.id} value={cat.id}>{cat.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2">Store Availability</label>
                                <p className="text-xs text-gray-500 mb-3">
                                    Select which stores sell this item and in which section.
                                </p>
                                {stores.map(store => {
                                    const storeData = editingItem.storeData[store.id] || {};
                                    const isAvailable = editingItem.storeData[store.id] !== undefined;
                                    return (
                                        <div key={store.id} className="mb-3 border rounded p-2 bg-gray-50">
                                            <div className="flex items-center gap-2 mb-2">
                                                <input
                                                    type="checkbox"
                                                    id={`store-${store.id}`}
                                                    checked={isAvailable}
                                                    onChange={(e) => {
                                                        setEditingItem(prev => {
                                                            const newStoreData = { ...(prev.storeData || {}) };
                                                            if (e.target.checked) {
                                                                newStoreData[store.id] = { section: '' };
                                                            } else {
                                                                delete newStoreData[store.id];
                                                            }
                                                            return { ...prev, storeData: newStoreData };
                                                        });
                                                    }}
                                                    className="w-4 h-4 cursor-pointer"
                                                />
                                                <label
                                                    htmlFor={`store-${store.id}`}
                                                    className="text-sm font-semibold cursor-pointer flex-1"
                                                >
                                                    {store.name}
                                                </label>
                                            </div>
                                            {isAvailable && (
                                                <select
                                                    value={storeData.section || ''}
                                                    onChange={(e) => {
                                                        const value = e.target.value;
                                                        setEditingItem(prev => {
                                                            const newStoreData = { ...(prev.storeData || {}) };
                                                            newStoreData[store.id] = { section: value };
                                                            return { ...prev, storeData: newStoreData };
                                                        });
                                                    }}
                                                    className="w-full px-3 py-1 border rounded text-sm ml-6"
                                                >
                                                    <option value="">No section selected</option>
                                                    {store.sections.map((sec, idx) => (
                                                        <option key={idx} value={sec}>{sec}</option>
                                                    ))}
                                                </select>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="pt-4 border-t">
                                <button
                                    onClick={handleDelete}
                                    className="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold flex items-center justify-center gap-2"
                                >
                                    Delete Item
                                </button>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 p-4 border-t">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 border rounded"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSave}
                                className="px-4 py-2 bg-green-600 text-white rounded"
                            >
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function StoreDetailModal({ store, onSave, onClose, onDelete }) {
            const [name, setName] = useState(store.name);
            const [sections, setSections] = useState(store.sections || []);
            const [newSection, setNewSection] = useState('');

            const handleAddSection = () => {
                const t = newSection.trim();
                if (!t) return;
                if (sections.includes(t)) return;
                setSections(prev => [...prev, t]);
                setNewSection('');
            };

            const handleSave = () => {
                onSave(store.id, { name, sections });
                onClose();
            };

            const handleDelete = () => {
                if (confirm(`Delete store "${store.name}"?`)) {
                    onDelete(store.id);
                    onClose();
                }
            };

            const handleSectionDelete = (idx) => {
                setSections(prev => prev.filter((_, i) => i !== idx));
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg w-full max-w-md max-height-[80vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-lg font-bold">Store Details</h2>
                            <button onClick={onClose}><XIcon /></button>
                        </div>
                        <div className="p-4 space-y-4 overflow-auto">
                            <div>
                                <label className="block text-sm font-semibold mb-1">Name</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full px-3 py-2 border rounded"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-1">Sections</label>
                                <div className="space-y-2">
                                    {sections.map((sec, idx) => (
                                        <div
                                            key={idx}
                                            className="flex items-center justify-between p-2 bg-gray-50 rounded"
                                        >
                                            <span>{sec}</span>
                                            <button
                                                onClick={() => handleSectionDelete(idx)}
                                                className="text-red-600 text-sm"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2 mt-3">
                                    <input
                                        type="text"
                                        value={newSection}
                                        onChange={(e) => setNewSection(e.target.value)}
                                        placeholder="New section"
                                        className="flex-1 px-3 py-2 border rounded"
                                    />
                                    <button
                                        onClick={handleAddSection}
                                        className="px-3 py-2 bg-green-600 text-white rounded"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                            <div className="pt-4 border-t">
                                <button
                                    onClick={handleDelete}
                                    className="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold"
                                >
                                    Delete Store
                                </button>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 p-4 border-t">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 border rounded"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSave}
                                className="px-4 py-2 bg-green-600 text-white rounded"
                            >
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        /* ---------------- SEARCH BAR ---------------- */

        function ItemsSearchBar({ onModeChange, onEditToggle, editMode }) {
            const [viewMode, setViewMode] = useState('categories');
            const inputRef = useRef(null);

            useEffect(() => {
                const input = inputRef.current;
                if (!input) return;

                const handleInput = (e) => {
                    const query = e.target.value.toLowerCase();
                    const allItems = document.querySelectorAll('[data-item-name]');
                    const allCategories = document.querySelectorAll('[data-category-section]');

                    allItems.forEach(node => {
                        const name = node.getAttribute('data-item-name').toLowerCase();
                        node.style.display = (!query || name.includes(query)) ? '' : 'none';
                    });

                    allCategories.forEach(cat => {
                        const visibleItems = cat.querySelectorAll('[data-item-name]:not([style*="display: none"])');
                        cat.style.display = (query && visibleItems.length === 0) ? 'none' : '';
                    });
                };

                input.addEventListener('input', handleInput);
                return () => input.removeEventListener('input', handleInput);
            }, []);

            const handleClear = () => {
                if (!inputRef.current) return;
                inputRef.current.value = '';
                const ev = new Event('input', { bubbles: true });
                inputRef.current.dispatchEvent(ev);
                inputRef.current.focus();
            };

            const changeMode = (mode) => {
                setViewMode(mode);
                onModeChange(mode);
            };

            return (
                <div className="p-4 space-y-3 border-b bg-white">
                    <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                            <button
                                onClick={onEditToggle}
                                className={`px-3 py-1 rounded-full text-xs font-semibold border ${
                                    editMode
                                        ? 'bg-red-50 text-red-600 border-red-200'
                                        : 'bg-gray-100 text-gray-600 border-gray-300'
                                }`}
                            >
                                {editMode ? 'Done' : 'Edit'}
                            </button>
                        </div>
                    </div>

                    <div className="relative">
                        <input
                            ref={inputRef}
                            type="text"
                            placeholder="Search items…"
                            defaultValue=""
                            className="w-full px-4 py-2 pr-10 border rounded-lg"
                        />
                        <button
                            type="button"
                            onClick={handleClear}
                            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                            &times;
                        </button>
                    </div>

                    <div className="flex gap-2">
                        <button
                            onClick={() => changeMode('categories')}
                            className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-all ${
                                viewMode === 'categories'
                                    ? 'bg-green-600 text-white shadow-md'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            Categories
                        </button>
                        <button
                            onClick={() => changeMode('alphabetical')}
                            className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-all ${
                                viewMode === 'alphabetical'
                                    ? 'bg-green-600 text-white shadow-md'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            Items Only
                        </button>
                    </div>
                </div>
            );
        }

        /* ---------------- MAIN APP ---------------- */

        function EzShopList() {
            const [stores, setStores] = useState([]);
            const [categories, setCategories] = useState([]);
            const [items, setItems] = useState([]);

            const [selectedStore, setSelectedStore] = useState('all');

            const [storesEditMode, setStoresEditMode] = useState(false);
            const [itemsEditMode, setItemsEditMode] = useState(false);

            const [itemsViewMode, setItemsViewMode] = useState('categories');
            const [expandedCategories, setExpandedCategories] = useState({});

            const [showStoreDetail, setShowStoreDetail] = useState(null);
            const [showItemDetail, setShowItemDetail] = useState(null);

            const [showAddStore, setShowAddStore] = useState(false);
            const [newStoreName, setNewStoreName] = useState('');
            const [showAddCategory, setShowAddCategory] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [showAddItem, setShowAddItem] = useState(false);
            const [newItemName, setNewItemName] = useState('');
            const [newItemCategory, setNewItemCategory] = useState('');

            const [activeTab, setActiveTab] = useState('stores');

            /* ---- LOAD/SAVE ---- */

            useEffect(() => {
                try {
                    const s = JSON.parse(localStorage.getItem('cartpal_stores') || '[]');
                    const c = JSON.parse(localStorage.getItem('cartpal_categories') || '[]');
                    const i = JSON.parse(localStorage.getItem('cartpal_items') || '[]');
                    setStores(s);
                    setCategories(c);
                    setItems(i);
                } catch (e) {
                    console.error('Failed to load data', e);
                }
            }, []);

            const saveStores = (data) => {
                setStores(data);
                localStorage.setItem('cartpal_stores', JSON.stringify(data));
            };

            const saveCategories = (data) => {
                const sorted = [...data].sort((a, b) => a.name.localeCompare(b.name));
                setCategories(sorted);
                localStorage.setItem('cartpal_categories', JSON.stringify(sorted));
            };

            const saveItems = (data) => {
                setItems(data);
                localStorage.setItem('cartpal_items', JSON.stringify(data));
            };

            /* ---- STORES ---- */

            const addStore = () => {
                const name = newStoreName.trim();
                if (!name) return;
                const newStore = {
                    id: Date.now(),
                    name,
                    sections: []
                };
                saveStores([...stores, newStore]);
                setNewStoreName('');
                setShowAddStore(false);
            };

            const deleteStore = (id) => {
                if (!confirm('Delete this store?')) return;
                saveStores(stores.filter(s => s.id !== id));

                const newItems = items.map(it => {
                    const sd = { ...(it.storeData || {}) };
                    if (sd[id]) {
                        delete sd[id];
                    }
                    return { ...it, storeData: sd };
                });
                saveItems(newItems);
                if (selectedStore === id) {
                    setSelectedStore('all');
                }
            };

            const updateStore = (id, updates) => {
                saveStores(stores.map(s => s.id === id ? { ...s, ...updates } : s));
            };

            const getStoreItemCount = (storeId) => {
                if (storeId === 'all') return items.filter(i => i.quantity > 0).length;
                return items.filter(i => i.quantity > 0 && i.storeData && i.storeData[storeId]).length;
            };

            const getStoresToVisitCount = () => {
                const setIds = new Set();
                items.forEach(it => {
                    if (it.quantity > 0 && it.storeData) {
                        Object.keys(it.storeData).forEach(k => setIds.add(k));
                    }
                });
                return setIds.size;
            };

            /* ---- CATEGORIES ---- */

            const addCategory = () => {
                const name = newCategoryName.trim();
                if (!name) return;
                const newCat = { id: Date.now(), name };
                saveCategories([...categories, newCat]);
                setNewCategoryName('');
                setShowAddCategory(false);
            };

            const deleteCategory = (id) => {
                if (!confirm('Delete this category?')) return;
                const updatedItems = items.map(it =>
                    it.categoryId === id ? { ...it, categoryId: null } : it
                );
                saveItems(updatedItems);
                saveCategories(categories.filter(c => c.id !== id));
            };

            const updateCategoryName = (id, newName) => {
                const t = newName.trim();
                if (!t) return;
                const updated = categories.map(c => c.id === id ? { ...c, name: t } : c);
                saveCategories(updated);
            };

            /* ---- ITEMS ---- */

            const addItem = () => {
                const name = newItemName.trim();
                if (!name || !newItemCategory) return;
                const newItem = {
                    id: Date.now(),
                    name,
                    categoryId: Number(newItemCategory),
                    quantity: 0,
                    bought: false,
                    storeData: {}
                };
                saveItems([...items, newItem]);
                setNewItemName('');
                setNewItemCategory('');
                setShowAddItem(false);
            };

            const deleteItem = (id) => {
                if (!confirm('Delete this item?')) return;
                saveItems(items.filter(i => i.id !== id));
            };

            const updateItem = (id, updates) => {
                const updated = items.map(i => i.id === id ? { ...i, ...updates } : i);
                saveItems(updated);
            };

            const getListItems = () => {
                return items
                    .filter(it => it.quantity > 0 && !isNaN(it.quantity))
                    .filter(it => {
                        if (selectedStore === 'all') return true;
                        return it.storeData && it.storeData[selectedStore];
                    })
                    .sort((a, b) => {
                        if (selectedStore !== 'all') {
                            const secA = (a.storeData[selectedStore] || {}).section || '';
                            const secB = (b.storeData[selectedStore] || {}).section || '';
                            if (secA !== secB) return secA.localeCompare(secB);
                        }
                        return a.name.localeCompare(b.name);
                    });
            };

            const getTotalItemQuantity = () =>
                items.reduce((sum, it) => sum + (it.quantity || 0), 0);

            /* ---- scroll helper LIST ---- */

            const getListScrollPosition = () => {
                const container = document.getElementById('list-scroll-container');
                return container ? container.scrollTop : 0;
            };

            const restoreListScrollPosition = (pos) => {
                const container = document.getElementById('list-scroll-container');
                if (container) container.scrollTop = pos;
            };

            const toggleBought = (itemId) => {
                const pos = getListScrollPosition();
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                updateItem(itemId, { bought: !item.bought });
                setTimeout(() => restoreListScrollPosition(pos), 0);
            };

            const clearBoughtItems = () => {
                const pos = getListScrollPosition();
                const cleared = items.map(i =>
                    i.bought ? { ...i, bought: false, quantity: 0 } : i
                );
                saveItems(cleared);
                setTimeout(() => restoreListScrollPosition(pos), 0);
            };

            /* ---- scroll helper ITEMS ---- */

            const updateQuantity = (itemId, delta) => {
                const container = document.getElementById('items-scroll-container');
                const pos = container ? container.scrollTop : 0;

                const updated = items.map(it => {
                    if (it.id === itemId) {
                        const current = it.quantity || 0;
                        const next = Math.max(0, current + delta);
                        return { ...it, quantity: next };
                    }
                    return it;
                });
                saveItems(updated);

                setTimeout(() => {
                    const c = document.getElementById('items-scroll-container');
                    if (c) c.scrollTop = pos;
                }, 0);
            };

            const addItemToList = (itemId) => {
                const container = document.getElementById('items-scroll-container');
                const pos = container ? container.scrollTop : 0;

                const updated = items.map(it => {
                    if (it.id === itemId) {
                        const current = it.quantity || 0;
                        const next = Math.max(1, current);
                        return { ...it, quantity: next };
                    }
                    return it;
                });
                saveItems(updated);

                setTimeout(() => {
                    const c = document.getElementById('items-scroll-container');
                    if (c) c.scrollTop = pos;
                }, 0);
            };

            const toggleCategory = (catId) => {
                const container = document.getElementById('items-scroll-container');
                const pos = container ? container.scrollTop : 0;
                setExpandedCategories(prev => ({
                    ...prev,
                    [catId]: !prev[catId]
                }));
                setTimeout(() => {
                    const c = document.getElementById('items-scroll-container');
                    if (c) c.scrollTop = pos;
                }, 0);
            };

            /* ---- CSV IMPORT/EXPORT ---- */

            const handleCSVImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(l => l.trim() !== '');
                        if (lines.length < 2) throw new Error('No data');

                        const headers = lines[0].split(',').map(h => h.trim());
                        const nameIdx = headers.indexOf('Name');
                        const qtyIdx = headers.indexOf('Quantity');
                        const catIdx = headers.indexOf('Category');

                        if (nameIdx === -1 || qtyIdx === -1 || catIdx === -1) {
                            throw new Error('Missing base headers');
                        }

                        const storeColumns = {};
                        headers.forEach((h, idx) => {
                            const m = h.match(/^(.+?)\s+(cost|section)$/);
                            if (m) {
                                const storeName = m[1];
                                const type = m[2];
                                if (!storeColumns[storeName]) storeColumns[storeName] = {};
                                storeColumns[storeName][type] = idx;
                            }
                        });

                        const newStores = Object.keys(storeColumns).map((name, i) => ({
                            id: Date.now() + i,
                            name,
                            sections: []
                        }));

                        const categoryMap = {};
                        const newItems = [];

                        for (let i = 1; i < lines.length; i++) {
                            const row = lines[i].split(',').map(v => v.trim());
                            const itemName = row[nameIdx];
                            const qty = parseInt(row[qtyIdx], 10) || 0;
                            const catName = row[catIdx];
                            if (!itemName || !catName) continue;

                            if (!categoryMap[catName]) {
                                categoryMap[catName] = {
                                    id: Date.now() + 1000 + Object.keys(categoryMap).length,
                                    name: catName
                                };
                            }

                            const storeData = {};
                            newStores.forEach(store => {
                                const cols = storeColumns[store.name];
                                if (!cols) return;
                                const sec = row[cols.section] || '';
                                if (sec) {
                                    storeData[store.id] = { section: sec };
                                    if (!store.sections.includes(sec))
                                        store.sections.push(sec);
                                }
                            });

                            newItems.push({
                                id: Date.now() + 2000 + i,
                                name: itemName,
                                categoryId: categoryMap[catName].id,
                                quantity: qty,
                                bought: false,
                                storeData
                            });
                        }

                        const newCategories = Object.values(categoryMap);
                        saveStores(newStores);
                        saveCategories(newCategories);
                        saveItems(newItems);

                        alert(`Imported: ${newStores.length} stores, ${newCategories.length} categories, ${newItems.length} items`);
                    } catch (err) {
                        console.error(err);
                        alert('Import failed. Please check the CSV format.');
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            };

            const handleCSVExport = () => {
                const headers = ['Name', 'Quantity', 'Category'];
                stores.forEach(store => {
                    headers.push(`${store.name} cost`, `${store.name} section`);
                });

                const escapeCSV = (field) => {
                    if (field === null || field === undefined) return '';
                    const s = String(field);
                    if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                        return `"${s.replace(/"/g, '""')}"`;
                    }
                    return s;
                };

                const lines = [];
                lines.push(headers.join(','));

                items.forEach(it => {
                    const cat = categories.find(c => c.id === it.categoryId);
                    const base = [
                        escapeCSV(it.name),
                        escapeCSV(it.quantity || 0),
                        escapeCSV(cat ? cat.name : '')
                    ];
                    const storeParts = [];
                    stores.forEach(store => {
                        const sd = (it.storeData || {})[store.id] || {};
                        storeParts.push(escapeCSV(''), escapeCSV(sd.section || ''));
                    });
                    lines.push([...base, ...storeParts].join(','));
                });

                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'cartpal_export.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            /* ---- TABS CONTENT ---- */

            const renderStoresTab = () => (
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center px-4 pt-4 pb-4 border-b">
                        <div className="flex-1">
                            <h1 className="text-xl font-bold">Stores</h1>
                            <div className="text-xs text-gray-500 mt-1">
                                Stores to visit: {getStoresToVisitCount()} ·
                                Items with qty: {items.filter(i => i.quantity > 0).length} ·
                                Total items: {items.length}
                            </div>
                        </div>
                        <button
                            onClick={() => setStoresEditMode(!storesEditMode)}
                            className="px-4 py-2 text-green-600 min-h-[44px]"
                        >
                            {storesEditMode ? 'Done' : 'Edit'}
                        </button>
                    </div>

                    <div className="flex-1 overflow-auto">
                        <div className="bg-gray-100 px-4 py-2 flex">
                            <div className="flex-1 font-semibold">Store Name</div>
                            <div className="w-20 text-center font-semibold">Qty</div>
                            <div className="w-20 text-center font-semibold">Selected</div>
                        </div>

                        <div
                            onClick={() => !storesEditMode && setSelectedStore('all')}
                            className="flex items-center px-4 py-3 border-b bg-white cursor-pointer hover:bg-gray-50"
                        >
                            <div className="flex-1 font-semibold">All Stores</div>
                            <div className="w-20 text-center">{getStoreItemCount('all')}</div>
                            <div className="w-20 text-center">
                                {selectedStore === 'all' && <CheckIcon />}
                            </div>
                        </div>

                        {stores.map(store => (
                            <div
                                key={store.id}
                                onClick={() => !storesEditMode && setSelectedStore(store.id)}
                                className="flex items-center px-4 py-3 border-b bg-white cursor-pointer hover:bg-gray-50"
                            >
                                <div className="flex-1">
                                    <div className="font-semibold">{store.name}</div>
                                    <div className="text-xs text-gray-500">
                                        Sections: {store.sections.length}
                                    </div>
                                </div>
                                <div className="w-20 text-center">
                                    {getStoreItemCount(store.id)}
                                </div>
                                <div className="w-20 text-center flex items-center justify-center gap-2">
                                    {selectedStore === store.id && <CheckIcon />}
                                    {storesEditMode && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setShowStoreDetail(store);
                                            }}
                                            className="text-xs underline text-green-600"
                                        >
                                            Edit
                                        </button>
                                    )}
                                    {storesEditMode && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                deleteStore(store.id);
                                            }}
                                            className="text-xs text-red-600"
                                        >
                                            Delete
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-4 border-t bg-white">
                        {!showAddStore ? (
                            <button
                                onClick={() => setShowAddStore(true)}
                                className="w-full py-2 border-2 border-dashed rounded flex items-center justify-center gap-2 text-green-600"
                            >
                                <PlusIcon /> <span>Add Store</span>
                            </button>
                        ) : (
                            <div className="space-y-2 bg-green-50 p-3 rounded border border-green-200">
                                <input
                                    type="text"
                                    value={newStoreName}
                                    onChange={(e) => setNewStoreName(e.target.value)}
                                    placeholder="Store name"
                                    className="w-full px-3 py-2 border rounded"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={addStore}
                                        className="flex-1 py-2 bg-green-600 text-white rounded"
                                    >
                                        Add Store
                                    </button>
                                    <button
                                        onClick={() => { setShowAddStore(false); setNewStoreName(''); }}
                                        className="flex-1 py-2 border rounded bg-white"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {showStoreDetail && (
                        <StoreDetailModal
                            store={showStoreDetail}
                            onSave={updateStore}
                            onClose={() => setShowStoreDetail(null)}
                            onDelete={deleteStore}
                        />
                    )}
                </div>
            );

            const renderItemsTab = () => {
                const sortedAlphabetical = [...items].sort((a, b) => a.name.localeCompare(b.name));

                const handleModeChange = (mode) => setItemsViewMode(mode);
                const handleEditToggle = () => setItemsEditMode(!itemsEditMode);

                return (
                    <div className="flex flex-col h-full">
                        <ItemsSearchBar
                            onModeChange={handleModeChange}
                            onEditToggle={handleEditToggle}
                            editMode={itemsEditMode}
                        />

                        <div id="items-scroll-container" className="flex-1 overflow-auto">
                            {itemsViewMode === 'categories' ? (
                                categories.map(category => {
                                    const categoryItems = items.filter(it => it.categoryId === category.id);
                                    return (
                                        <div key={category.id} className="border-b" data-category-section>
                                            <div
                                                onClick={() => toggleCategory(category.id)}
                                                className="flex items-center px-4 py-3 bg-gray-50 cursor-pointer hover:bg-gray-100"
                                            >
                                                {itemsEditMode && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            deleteCategory(category.id);
                                                        }}
                                                        className="mr-2 text-red-600"
                                                    >
                                                        <MinusIcon />
                                                    </button>
                                                )}
                                                {expandedCategories[category.id]
                                                    ? <ChevronDownIcon />
                                                    : <ChevronRightIcon />}
                                                <span
                                                    className="font-semibold ml-2"
                                                    onClick={(e) => {
                                                        if (!itemsEditMode) return;
                                                        e.stopPropagation();
                                                        const newName = prompt('Rename category', category.name);
                                                        if (newName !== null) {
                                                            updateCategoryName(category.id, newName);
                                                        }
                                                    }}
                                                >
                                                    {category.name} ({categoryItems.length})
                                                </span>
                                            </div>
                                            {expandedCategories[category.id] && (
                                                <div>
                                                    {categoryItems.map(item => (
                                                        <div
                                                            key={item.id}
                                                            data-item-id={item.id}
                                                            data-item-name={item.name}
                                                            className="flex items-center px-4 py-3 pl-12 border-b bg-white hover:bg-gray-50 cursor-pointer"
                                                            onClick={() => {
                                                                if (!itemsEditMode) {
                                                                    addItemToList(item.id);
                                                                }
                                                            }}
                                                        >
                                                            {itemsEditMode && (
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        deleteItem(item.id);
                                                                    }}
                                                                    className="mr-2 text-red-600"
                                                                >
                                                                    <MinusIcon />
                                                                </button>
                                                            )}
                                                            <div className="flex-1">
                                                                {item.name}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        updateQuantity(item.id, -1);
                                                                    }}
                                                                    className="w-8 h-8 flex items-center justify-center border rounded active:bg-gray-200"
                                                                >
                                                                    <MinusIcon />
                                                                </button>
                                                                <span className="w-12 text-center item-qty">
                                                                    {item.quantity || 0}
                                                                </span>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        updateQuantity(item.id, 1);
                                                                    }}
                                                                    className="w-8 h-8 flex items-center justify-center border rounded active:bg-gray-200"
                                                                >
                                                                    <PlusIcon />
                                                                </button>
                                                            </div>
                                                            {!itemsEditMode && (
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setShowItemDetail(item);
                                                                    }}
                                                                    className="ml-2"
                                                                >
                                                                    <ChevronRightSmallIcon />
                                                                </button>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            ) : (
                                <div>
                                    {sortedAlphabetical.map(item => {
                                        const category = categories.find(c => c.id === item.categoryId);
                                        return (
                                            <div
                                                key={item.id}
                                                data-item-id={item.id}
                                                data-item-name={item.name}
                                                className="flex items-center px-4 py-3 border-b bg-white hover:bg-gray-50 cursor-pointer"
                                                onClick={() => {
                                                    if (!itemsEditMode) {
                                                        addItemToList(item.id);
                                                    }
                                                }}
                                            >
                                                {itemsEditMode && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            deleteItem(item.id);
                                                        }}
                                                        className="mr-2 text-red-600"
                                                    >
                                                        <MinusIcon />
                                                    </button>
                                                )}
                                                <div className="flex-1">
                                                    <div className="font-medium">{item.name}</div>
                                                    <div className="text-sm text-gray-600">
                                                        {category ? category.name : 'No category'}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            updateQuantity(item.id, -1);
                                                        }}
                                                        className="w-8 h-8 flex items-center justify-center border rounded active:bg-gray-200"
                                                    >
                                                        <MinusIcon />
                                                    </button>
                                                    <span className="w-12 text-center item-qty">
                                                        {item.quantity || 0}
                                                    </span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            updateQuantity(item.id, 1);
                                                        }}
                                                        className="w-8 h-8 flex items-center justify-center border rounded active:bg-gray-200"
                                                    >
                                                        <PlusIcon />
                                                    </button>
                                                </div>
                                                {!itemsEditMode && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setShowItemDetail(item);
                                                        }}
                                                        className="ml-2"
                                                    >
                                                        <ChevronRightSmallIcon />
                                                    </button>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t bg-white">
                            {!showAddItem ? (
                                <button
                                    onClick={() => setShowAddItem(true)}
                                    className="w-full py-2 border-2 border-dashed rounded flex items-center justify-center gap-2 text-green-600"
                                >
                                    <PlusIcon /> <span>Add Item</span>
                                </button>
                            ) : (
                                <div className="space-y-2 bg-green-50 p-3 rounded border border-green-200">
                                    <input
                                        type="text"
                                        value={newItemName}
                                        onChange={(e) => setNewItemName(e.target.value)}
                                        placeholder="Item name"
                                        className="w-full px-3 py-2 border rounded"
                                        autoFocus
                                    />
                                    <select
                                        value={newItemCategory}
                                        onChange={(e) => setNewItemCategory(e.target.value)}
                                        className="w-full px-3 py-2 border rounded"
                                    >
                                        <option value="">Select category</option>
                                        {categories.map(cat => (
                                            <option key={cat.id} value={cat.id}>{cat.name}</option>
                                        ))}
                                    </select>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={addItem}
                                            className="flex-1 py-2 bg-green-600 text-white rounded"
                                        >
                                            Add Item
                                        </button>
                                        <button
                                            onClick={() => { setShowAddItem(false); setNewItemName(''); setNewItemCategory(''); }}
                                            className="flex-1 py-2 border rounded bg-white"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {showItemDetail && (
                            <ItemDetailModal
                                item={showItemDetail}
                                stores={stores}
                                categories={categories}
                                onSave={updateItem}
                                onClose={() => setShowItemDetail(null)}
                                onDelete={deleteItem}
                            />
                        )}
                    </div>
                );
            };

            const renderListTab = () => {
                const listItems = getListItems();
                const toBuy = listItems.filter(i => !i.bought);
                const bought = listItems.filter(i => i.bought);

                return (
                    <div className="flex flex-col h-full">
                        <div className="flex justify-between items-center px-4 pt-4 pb-4 border-b">
                            <h1 className="text-xl font-bold">
                                {selectedStore === 'all'
                                    ? 'All Stores'
                                    : (stores.find(s => s.id === selectedStore)?.name || 'Select Store')}
                            </h1>
                            {bought.length > 0 && (
                                <button
                                    onClick={clearBoughtItems}
                                    className="px-4 py-2 text-green-600"
                                >
                                    Clear
                                </button>
                            )}
                        </div>
                        <div id="list-scroll-container" className="flex-1 overflow-auto">
                            {toBuy.length > 0 && (
                                <div>
                                    <div className="bg-gray-100 px-4 py-2 font-semibold">To Buy</div>
                                    {toBuy.map(item => {
                                        const cat = categories.find(c => c.id === item.categoryId);
                                        const section = selectedStore !== 'all'
                                            ? (item.storeData[selectedStore] || {}).section
                                            : null;
                                        return (
                                            <div
                                                key={item.id}
                                                onClick={() => toggleBought(item.id)}
                                                className="flex items-center px-4 py-3 border-b bg-white cursor-pointer hover:bg-gray-50"
                                            >
                                                <div className="flex-1">
                                                    <div className="font-medium">{item.name}</div>
                                                    <div className="text-sm text-gray-600">
                                                        {section && <span className="mr-2">[{section}]</span>}
                                                        {cat ? cat.name : 'No category'}
                                                        {item.quantity ? ` · Qty: ${item.quantity}` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {bought.length > 0 && (
                                <div>
                                    <div className="bg-gray-100 px-4 py-2 font-semibold">Bought</div>
                                    {bought.map(item => {
                                        const cat = categories.find(c => c.id === item.categoryId);
                                        const section = selectedStore !== 'all'
                                            ? (item.storeData[selectedStore] || {}).section
                                            : null;
                                        return (
                                            <div
                                                key={item.id}
                                                onClick={() => toggleBought(item.id)}
                                                className="flex items-center px-4 py-3 border-b bg-gray-50 cursor-pointer"
                                            >
                                                <div className="flex-1">
                                                    <div className="font-medium line-through text-gray-500">
                                                        {item.name}
                                                    </div>
                                                    <div className="text-sm text-gray-500">
                                                        {section && <span className="mr-2">[{section}]</span>}
                                                        {cat ? cat.name : 'No category'}
                                                        {item.quantity ? ` · Qty: ${item.quantity}` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {toBuy.length === 0 && bought.length === 0 && (
                                <div className="flex items-center justify-center h-full text-gray-400">
                                    No items on your list yet.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderFileTab = () => (
                <div className="flex flex-col h-full">
                    <div className="px-4 pt-4 pb-4 border-b">
                        <h1 className="text-xl font-bold">File Management</h1>
                    </div>
                    <div className="flex-1 p-4 space-y-4 overflow-auto">
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 className="font-semibold mb-2">Import CSV</h3>
                            <p className="text-sm text-gray-600 mb-3">
                                Import your data from a CartPal CSV export.
                            </p>
                            <label className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded cursor-pointer hover:bg-green-700">
                                <UploadIcon />
                                <span>Choose CSV File</span>
                                <input
                                    type="file"
                                    accept=".csv"
                                    onChange={handleCSVImport}
                                    className="hidden"
                                />
                            </label>
                        </div>

                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 className="font-semibold mb-2">Export CSV</h3>
                            <p className="text-sm text-gray-600 mb-3">
                                Export your current data as CSV backup.
                            </p>
                            <button
                                onClick={handleCSVExport}
                                className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 w-full"
                            >
                                <DownloadIcon />
                                <span>Download CSV</span>
                            </button>
                        </div>

                        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 className="font-semibold mb-2">Data Storage</h3>
                            <div className="text-sm text-gray-600 space-y-1">
                                <p>• Stores: {stores.length}</p>
                                <p>• Categories: {categories.length}</p>
                                <p>• Items: {items.length}</p>
                                <p className="mt-3 text-xs">
                                    Data is automatically saved on your device (localStorage).
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderHelpTab = () => (
                <div className="flex flex-col h-full overflow-auto">
                    <div className="px-4 pt-4 pb-4 border-b bg-green-600 text-white">
                        <h1 className="text-xl font-bold">CartPal User Manual</h1>
                        <p className="text-sm mt-1 opacity-90">
                            How to use this shopping list app
                        </p>
                    </div>

                    <div className="p-4 space-y-6">
                        {/* Overview */}
                        <section>
                            <h2 className="text-lg font-bold mb-2 text-green-600">Overview</h2>
                            <p className="text-sm text-gray-700">
                                CartPal helps you organize your shopping across multiple stores.
                                You create items, group them in categories, mark which stores sell
                                them and in which section, and then build your shopping list per store.
                            </p>
                        </section>

                        {/* Key Concepts */}
                        <section>
                            <h2 className="text-lg font-bold mb-2 text-green-600">Key concepts</h2>
                            <ul className="text-sm text-gray-700 space-y-1 ml-4 list-disc">
                                <li>
                                    <strong>Store</strong> – a supermarket or shop where you buy items.
                                </li>
                                <li>
                                    <strong>Section</strong> – an aisle or area in that store
                                    (e.g. "Produce", "Dairy", "Frozen").
                                </li>
                                <li>
                                    <strong>Category</strong> – a logical group for items
                                    (e.g. "Vegetables", "Breakfast", "Cleaning").
                                </li>
                                <li>
                                    <strong>Item</strong> – a product you want to buy (e.g. "Milk", "Apples").
                                </li>
                                <li>
                                    <strong>Quantity</strong> – how many units you want to buy.
                                </li>
                                <li>
                                    <strong>Bought</strong> – whether you have already picked up the item.
                                </li>
                            </ul>
                        </section>

                        {/* Tabs */}
                        <section>
                            <h2 className="text-lg font-bold mb-2 text-green-600">Tabs in CartPal</h2>
                            <ul className="text-sm text-gray-700 space-y-2 ml-4">
                                <li>
                                    <strong>Stores</strong> – add and edit stores, define sections,
                                    and select which store you are shopping in.
                                </li>
                                <li>
                                    <strong>Items</strong> – manage all items and categories,
                                    and set quantities for your list.
                                </li>
                                <li>
                                    <strong>List</strong> – your actual shopping list, filtered
                                    by store and sorted by section.
                                </li>
                                <li>
                                    <strong>File</strong> – import/export your data via CSV
                                    (for backup or moving data).
                                </li>
                                <li>
                                    <strong>Help</strong> – this manual and the feedback button.
                                </li>
                            </ul>
                        </section>

                        {/* Quick Start */}
                        <section>
                            <h2 className="text-lg font-bold mb-2 text-green-600">Quick start</h2>
                            <ol className="text-sm text-gray-700 space-y-2 ml-4 list-decimal">
                                <li>Go to <strong>Stores</strong> and add one or more stores.</li>
                                <li>Optionally, add store sections (e.g. "Produce", "Dairy", "Bread").</li>
                                <li>Go to <strong>Items</strong> and create categories and items.</li>
                                <li>In the item details, mark which stores sell the item and in which section.</li>
                                <li>
                                    In the <strong>Items</strong> tab, tap an item to put it on
                                    your list (quantity becomes at least 1).
                                </li>
                                <li>
                                    Go to the <strong>List</strong> tab and select a store to see
                                    what to buy there.
                                </li>
                                <li>Tap an item on the list to mark it as bought.</li>
                            </ol>
                        </section>

                        {/* Tips */}
                        <section>
                            <h2 className="text-lg font-bold mb-2 text-green-600">Tips & tricks</h2>
                            <ul className="text-sm text-gray-700 space-y-2 ml-4 list-disc">
                                <li>
                                    Use <strong>Categories</strong> to keep items manageable
                                    and easier to find.
                                </li>
                                <li>
                                    In the <strong>Items</strong> tab you can switch between
                                    viewing by category or a simple alphabetical list.
                                </li>
                                <li>
                                    Use the <strong>search bar</strong> in the Items tab to
                                    quickly jump to a specific product.
                                </li>
                                <li>
                                    The app remembers your scroll position per tab, so you can
                                    switch between Stores / Items / List without losing your place.
                                </li>
                            </ul>
                        </section>

                        {/* Feedback Section */}
                        <section className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <h2 className="text-lg font-bold mb-2 text-green-600">💬 Share your feedback</h2>
                            <p className="text-sm text-gray-700 mb-3">
                                We’d love to hear from you. Your feedback helps make CartPal better
                                and more pleasant to use.
                            </p>
                            <p className="text-sm text-gray-600 mb-3">
                                In this Help tab you will see a small green{" "}
                                <span className="inline-flex items-center justify-center w-6 h-6 bg-green-600 text-white rounded-full text-center leading-6">
                                    💬
                                </span>{" "}
                                button in the bottom-right corner of the screen.
                                Tap it to open the feedback form.
                            </p>
                            <ul className="text-sm text-gray-700 space-y-1 ml-4 list-disc">
                                <li>Share what works well for you.</li>
                                <li>Report bugs or strange behaviour.</li>
                                <li>Suggest improvements or new features.</li>
                            </ul>
                        </section>
                    </div>
                </div>
            );

            /* ---- MAIN RENDER ---- */

            return (
                <div className="flex flex-col h-screen bg-white">
                    <div className="flex-1 overflow-hidden">
                        <div className={activeTab === 'stores' ? 'h-full' : 'hidden'}>
                            {renderStoresTab()}
                        </div>
                        <div className={activeTab === 'items' ? 'h-full' : 'hidden'}>
                            {renderItemsTab()}
                        </div>
                        <div className={activeTab === 'list' ? 'h-full' : 'hidden'}>
                            {renderListTab()}
                        </div>
                        <div className={activeTab === 'file' ? 'h-full' : 'hidden'}>
                            {renderFileTab()}
                        </div>
                        <div className={activeTab === 'help' ? 'h-full' : 'hidden'}>
                            {renderHelpTab()}
                        </div>
                    </div>

                    {/* 💬 Floating Feedback Button - only on Help tab */}
                    {activeTab === 'help' && (
                        <a
                            href="https://forms.gle/2J1L8CUDocywCXQy5"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="fixed bottom-24 right-6 w-12 h-12 bg-green-600 text-white rounded-full text-2xl flex items-center justify-center shadow-lg hover:bg-green-700 hover:scale-110 transition-transform z-50"
                            style={{ marginBottom: 'env(safe-area-inset-bottom)' }}
                            aria-label="Send feedback"
                        >
                            💬
                        </a>
                    )}

                    {/* Bottom Nav */}
                    <div className="flex border-t bg-white bottom-nav">
                        <button
                            onClick={() => setActiveTab('stores')}
                            className={`flex-1 flex flex-col items-center py-3 ${
                                activeTab === 'stores' ? 'text-green-600' : 'text-gray-400'
                            }`}
                        >
                            <StoreIcon />
                            <span className="text-xs mt-1">Stores</span>
                        </button>
                        <button
                            onClick={() => setActiveTab('items')}
                            className={`flex-1 flex flex-col items-center py-3 ${
                                activeTab === 'items' ? 'text-green-600' : 'text-gray-400'
                            }`}
                        >
                            <ItemsIcon />
                            <span className="text-xs mt-1">Items</span>
                        </button>
                        <button
                            onClick={() => setActiveTab('list')}
                            className={`flex-1 flex flex-col items-center py-3 relative ${
                                activeTab === 'list' ? 'text-green-600' : 'text-gray-400'
                            }`}
                        >
                            <div className="relative">
                                <CartIcon />
                                {getTotalItemQuantity() > 0 && (
                                    <span className="absolute -top-1 -right-2 bg-yellow-500 text-white text-xs rounded-full min-w-[20px] h-5 px-1 flex items-center justify-center font-bold">
                                        {getTotalItemQuantity()}
                                    </span>
                                )}
                            </div>
                            <span className="text-xs mt-1">List</span>
                        </button>
                        <button
                            onClick={() => setActiveTab('file')}
                            className={`flex-1 flex flex-col items-center py-3 ${
                                activeTab === 'file' ? 'text-green-600' : 'text-gray-400'
                            }`}
                        >
                            <FolderIcon />
                            <span className="text-xs mt-1">File</span>
                        </button>
                        <button
                            onClick={() => setActiveTab('help')}
                            className={`flex-1 flex flex-col items-center py-3 ${
                                activeTab === 'help' ? 'text-green-600' : 'text-gray-400'
                            }`}
                        >
                            <InfoIcon />
                            <span className="text-xs mt-1">Help</span>
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EzShopList />, document.getElementById('root'));
    </script>
</body>
</html>
